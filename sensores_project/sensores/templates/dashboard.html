{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2>Dados em Tempo Real</h2>
    <p class="text-muted">
        <i class="fas fa-clock"></i> 
        Última atualização: <span id="data_hora" class="fw-bold">--</span>
    </p>
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Temperatura</h5>
                            <p class="card-text h4"><span id="temperatura">--</span>°C</p>
                        </div>
                        <div style="width: 100px; height: 50px;">
                            <canvas id="tempChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Umidade</h5>
                            <p class="card-text h4"><span id="umidade">--</span>%</p>
                        </div>
                        <div style="width: 100px; height: 50px;">
                            <canvas id="umidChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Luminosidade</h5>
                            <p class="card-text h4"><span id="luminosidade">--</span> lux</p>
                        </div>
                        <div style="width: 100px; height: 50px;">
                            <canvas id="luxChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Qualidade do Ar</h5>
                            <p class="card-text h4"><span id="qualidade_ar">--</span></p>
                        </div>
                        <div style="width: 100px; height: 50px;">
                            <canvas id="arChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Chuva</h5>
                            <p class="card-text h4"><span id="chuva">--</span> mm</p>
                        </div>
                        <div style="width: 100px; height: 50px;">
                            <canvas id="chuvaChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Adicione o Chart.js antes do seu script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let ws = null;
    const maxDataPoints = 10;
    
    const tempData = Array(maxDataPoints).fill(0);
    const umidData = Array(maxDataPoints).fill(0);
    const luxData = Array(maxDataPoints).fill(0);
    const arData = Array(maxDataPoints).fill(0);
    const chuvaData = Array(maxDataPoints).fill(0);

    const chartConfig = {
        type: 'bar',
        data: {
            labels: Array(maxDataPoints).fill(''),
            datasets: [{
                data: [],
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { display: false }
            },
            animation: false
        }
    };

    const tempChart = new Chart(
        document.getElementById('tempChart').getContext('2d'),
        {...chartConfig, data: {...chartConfig.data, datasets: [{...chartConfig.data.datasets[0], backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgba(255, 99, 132, 1)'}]}}
    );

    const umidChart = new Chart(
        document.getElementById('umidChart').getContext('2d'),
        {...chartConfig, data: {...chartConfig.data, datasets: [{...chartConfig.data.datasets[0], backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgba(54, 162, 235, 1)'}]}}
    );

    const luxChart = new Chart(
        document.getElementById('luxChart').getContext('2d'),
        {...chartConfig, data: {...chartConfig.data, datasets: [{...chartConfig.data.datasets[0], backgroundColor: 'rgba(255, 206, 86, 0.2)', borderColor: 'rgba(255, 206, 86, 1)'}]}}
    );

    const arChart = new Chart(
        document.getElementById('arChart').getContext('2d'),
        {...chartConfig, data: {...chartConfig.data, datasets: [{...chartConfig.data.datasets[0], backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)'}]}}
    );

    const chuvaChart = new Chart(
        document.getElementById('chuvaChart').getContext('2d'),
        {...chartConfig, data: {...chartConfig.data, datasets: [{...chartConfig.data.datasets[0], backgroundColor: 'rgba(153, 102, 255, 0.2)', borderColor: 'rgba(153, 102, 255, 1)'}]}}
    );

    function atualizarGrafico(chart, novoValor, dataArray) {
        dataArray.shift();
        dataArray.push(novoValor);
        chart.data.datasets[0].data = dataArray;
        chart.update('none');
    }

    function formatarDataHora(dataString) {
        const data = new Date(dataString);
        return data.toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    
    function conectarWebSocket() {
        ws = new WebSocket(`ws://${window.location.host}/ws/dashboard/`);
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            document.getElementById('temperatura').textContent = data.temperatura;
            document.getElementById('umidade').textContent = data.umidade;
            document.getElementById('luminosidade').textContent = data.luminosidade;
            document.getElementById('qualidade_ar').textContent = data.qualidade_ar;
            document.getElementById('chuva').textContent = data.chuva;
            document.getElementById('data_hora').textContent = formatarDataHora(data.data_hora);

            atualizarGrafico(tempChart, data.temperatura, tempData);
            atualizarGrafico(umidChart, data.umidade, umidData);
            atualizarGrafico(luxChart, data.luminosidade, luxData);
            atualizarGrafico(arChart, data.qualidade_ar, arData);
            atualizarGrafico(chuvaChart, data.chuva, chuvaData);
        };

        ws.onclose = function(e) {
            console.log('WebSocket desconectado. Tentando reconectar em 5 segundos...');
            setTimeout(conectarWebSocket, 5000);
        };

        ws.onerror = function(err) {
            console.error('Erro no WebSocket:', err);
            ws.close();
        };
    }

    conectarWebSocket();
</script>
{% endblock %}