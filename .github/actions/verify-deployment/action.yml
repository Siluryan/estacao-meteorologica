name: 'Verify Deployment'
description: 'Verifica o status do deployment na EC2 via SSM'

inputs:
  instance_id:
    description: 'Instance ID da EC2'
    required: true
  project_path:
    description: 'Caminho do projeto na EC2'
    required: false
    default: '~/estacao-meteorologica'
  services:
    description: 'Serviços para verificar (separados por vírgula)'
    required: false
    default: 'web consumer'
  log_lines:
    description: 'Número de linhas de log para exibir'
    required: false
    default: '20'

runs:
  using: 'composite'
  steps:
    - name: Verify deployment
      uses: ./.github/actions/run-ssm-command
      with:
        instance_id: ${{ inputs.instance_id }}
        command: |
          set -e
          
          INPUT_PATH="${{ inputs.project_path }}"
          EXPANDED_PATH=$(echo "$INPUT_PATH" | sed "s|^~|$HOME|")
          
          if [ -d "/home/ec2-user/estacao-meteorologica" ]; then
            PROJECT_DIR="/home/ec2-user/estacao-meteorologica"
          elif [ -d "/home/ubuntu/estacao-meteorologica" ]; then
            PROJECT_DIR="/home/ubuntu/estacao-meteorologica"
          elif [ -d "$EXPANDED_PATH" ]; then
            PROJECT_DIR="$EXPANDED_PATH"
          elif [ -d "$HOME/estacao-meteorologica" ]; then
            PROJECT_DIR="$HOME/estacao-meteorologica"
          elif [ -d "/opt/estacao-meteorologica" ]; then
            PROJECT_DIR="/opt/estacao-meteorologica"
          else
            echo "Erro: Diretório do projeto não encontrado"
            exit 1
          fi
          
          cd "$PROJECT_DIR" || exit 1
          echo "Verificando deployment em: $(pwd)"
          
          if [ ! -f "docker-compose.yaml" ] && [ ! -f "docker-compose.yml" ]; then
            echo "Erro: Arquivo docker-compose.yaml não encontrado em $(pwd)"
            ls -la
            exit 1
          fi
          
          echo "Status dos containers:"
          docker-compose ps
          
          echo ""
          echo "Logs dos serviços:"
          for service in ${{ inputs.services }}; do
            echo ""
            echo "=== Logs de $service ==="
            docker-compose logs --tail=${{ inputs.log_lines }} $service || true
          done

