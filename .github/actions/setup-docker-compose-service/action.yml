name: 'Setup Docker Compose Service'
description: 'Configura serviço systemd para manter Docker Compose rodando após reinicialização'

inputs:
  instance_id:
    description: 'Instance ID da EC2'
    required: true
  project_path:
    description: 'Caminho do projeto'
    required: false
    default: '~/estacao-meteorologica'
  user:
    description: 'Usuário do sistema'
    required: false
    default: 'ec2-user'

runs:
  using: 'composite'
  steps:
    - name: Setup Docker Compose systemd service
      uses: ./.github/actions/run-ssm-command
      with:
        instance_id: ${{ inputs.instance_id }}
        command: |
          PROJECT_PATH="${{ inputs.project_path }}"
          USER="${{ inputs.user }}"
          
          cd $PROJECT_PATH || cd ~/estacao-meteorologica || cd /home/ec2-user/estacao-meteorologica || cd /opt/estacao-meteorologica
          
          PROJECT_ABS_PATH=$(pwd)
          COMPOSE_CMD=$(command -v docker-compose || command -v docker || echo "docker-compose")
          
          if command -v docker-compose &> /dev/null; then
            COMPOSE_CMD=$(command -v docker-compose)
          elif docker compose version &> /dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          if [ "$COMPOSE_CMD" = "docker compose" ]; then
            sudo tee /etc/systemd/system/docker-compose-app.service > /dev/null << EOF
[Unit]
Description=Docker Compose Application Service
Requires=docker.service
After=docker.service network-online.target
Wants=network-online.target

[Service]
Type=oneshot
RemainAfterExit=yes
User=$USER
Group=$USER
WorkingDirectory=$PROJECT_ABS_PATH
Environment="PATH=/usr/local/bin:/usr/bin:/bin"

ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down

StandardOutput=journal
StandardError=journal

Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
          else
            sudo tee /etc/systemd/system/docker-compose-app.service > /dev/null << EOF
[Unit]
Description=Docker Compose Application Service
Requires=docker.service
After=docker.service network-online.target
Wants=network-online.target

[Service]
Type=oneshot
RemainAfterExit=yes
User=$USER
Group=$USER
WorkingDirectory=$PROJECT_ABS_PATH
Environment="PATH=/usr/local/bin:/usr/bin:/bin"

ExecStart=$COMPOSE_CMD up -d
ExecStop=$COMPOSE_CMD down

StandardOutput=journal
StandardError=journal

Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
          fi
          
          sudo systemctl daemon-reload
          sudo systemctl enable docker-compose-app.service