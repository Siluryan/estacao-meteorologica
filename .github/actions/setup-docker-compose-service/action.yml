name: 'Setup Docker Compose Service'
description: 'Configura serviço systemd para manter Docker Compose rodando após reinicialização'

inputs:
  instance_id:
    description: 'Instance ID da EC2'
    required: true
  project_path:
    description: 'Caminho do projeto'
    required: false
    default: '~/estacao-meteorologica'
  user:
    description: 'Usuário do sistema'
    required: false
    default: 'ec2-user'

runs:
  using: 'composite'
  steps:
    - name: Setup Docker Compose systemd service
      uses: ./.github/actions/run-ssm-command
      with:
        instance_id: ${{ inputs.instance_id }}
        command: |
          PROJECT_PATH="${{ inputs.project_path }}"
          USER="${{ inputs.user }}"
          
          cd $PROJECT_PATH || cd ~/estacao-meteorologica || cd /home/ec2-user/estacao-meteorologica || cd /opt/estacao-meteorologica
          
          PROJECT_ABS_PATH=$(pwd)
          COMPOSE_CMD=$(command -v docker-compose || command -v docker || echo "docker-compose")
          
          if command -v docker-compose &> /dev/null; then
            COMPOSE_CMD=$(command -v docker-compose)
          elif docker compose version &> /dev/null; then
            COMPOSE_CMD="docker compose"
          else
            COMPOSE_CMD="docker-compose"
          fi
          
          SERVICE_FILE=$(mktemp)
          
          printf '[Unit]\n' > "$SERVICE_FILE"
          printf 'Description=Docker Compose Application Service\n' >> "$SERVICE_FILE"
          printf 'Requires=docker.service\n' >> "$SERVICE_FILE"
          printf 'After=docker.service network-online.target\n' >> "$SERVICE_FILE"
          printf 'Wants=network-online.target\n' >> "$SERVICE_FILE"
          printf '\n' >> "$SERVICE_FILE"
          printf '[Service]\n' >> "$SERVICE_FILE"
          printf 'Type=oneshot\n' >> "$SERVICE_FILE"
          printf 'RemainAfterExit=yes\n' >> "$SERVICE_FILE"
          printf "User=$USER\n" >> "$SERVICE_FILE"
          printf "Group=$USER\n" >> "$SERVICE_FILE"
          printf "WorkingDirectory=$PROJECT_ABS_PATH\n" >> "$SERVICE_FILE"
          printf 'Environment="PATH=/usr/local/bin:/usr/bin:/bin"\n' >> "$SERVICE_FILE"
          printf '\n' >> "$SERVICE_FILE"
          
          if [ "$COMPOSE_CMD" = "docker compose" ]; then
            printf 'ExecStart=/usr/bin/docker compose up -d\n' >> "$SERVICE_FILE"
            printf 'ExecStop=/usr/bin/docker compose down\n' >> "$SERVICE_FILE"
          else
            printf "ExecStart=$COMPOSE_CMD up -d\n" >> "$SERVICE_FILE"
            printf "ExecStop=$COMPOSE_CMD down\n" >> "$SERVICE_FILE"
          fi
          
          printf '\n' >> "$SERVICE_FILE"
          printf 'StandardOutput=journal\n' >> "$SERVICE_FILE"
          printf 'StandardError=journal\n' >> "$SERVICE_FILE"
          printf '\n' >> "$SERVICE_FILE"
          printf 'Restart=on-failure\n' >> "$SERVICE_FILE"
          printf 'RestartSec=10\n' >> "$SERVICE_FILE"
          printf '\n' >> "$SERVICE_FILE"
          printf '[Install]\n' >> "$SERVICE_FILE"
          printf 'WantedBy=multi-user.target\n' >> "$SERVICE_FILE"
          
          sudo cp "$SERVICE_FILE" /etc/systemd/system/docker-compose-app.service
          rm -f "$SERVICE_FILE"
          
          sudo systemctl daemon-reload
          sudo systemctl enable docker-compose-app.service