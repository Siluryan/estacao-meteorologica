name: Setup Parameter Store

on:
  workflow_dispatch:
    inputs:
      postgres_user:
        description: 'PostgreSQL user'
        required: false
        default: 'sensores_prod'
      postgres_password:
        description: 'PostgreSQL password (SecureString)'
        required: true
        type: string
      mqtt_broker:
        description: 'MQTT broker hostname'
        required: false
        default: 'rabbitmq'
      mqtt_username:
        description: 'MQTT username'
        required: true
        type: string
      mqtt_password:
        description: 'MQTT password (SecureString)'
        required: true
        type: string
      
      rabbitmq_user:
        description: 'RabbitMQ default user'
        required: false
        default: 'mqtt_user'
      rabbitmq_password:
        description: 'RabbitMQ default password (SecureString)'
        required: true
        type: string
      
      django_secret_key:
        description: 'Django SECRET_KEY (SecureString)'
        required: true
        type: string
      django_superuser_username:
        description: 'Django superuser username'
        required: false
        default: 'admin'
      django_superuser_password:
        description: 'Django superuser password (SecureString)'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: 'us-east-1'
  PARAM_PREFIX: '/agrostation/prod'

jobs:
  setup-parameters:
    runs-on: ubuntu-22.04
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::914256152987:role/Agrostation
          role-session-name: github-actions-setup-params

      - name: Create Database Parameters
        run: |
          OVERWRITE_FLAG="--overwrite"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/database/name" \
            --value "sensores_prod" \
            --type "String" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: PostgreSQL database name"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/database/user" \
            --value "${{ github.event.inputs.postgres_user }}" \
            --type "String" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: PostgreSQL user"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/database/password" \
            --value "${{ github.event.inputs.postgres_password }}" \
            --type "SecureString" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: PostgreSQL password"
          
          
          echo "Database parameters created"

      - name: Create MQTT Parameters
        run: |
          OVERWRITE_FLAG="--overwrite"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/mqtt/broker" \
            --value "${{ github.event.inputs.mqtt_broker }}" \
            --type "String" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: MQTT broker hostname"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/mqtt/topic" \
            --value "estacao/meteorologica" \
            --type "String" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: MQTT topic"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/mqtt/username" \
            --value "${{ github.event.inputs.mqtt_username }}" \
            --type "String" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: MQTT username"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/mqtt/password" \
            --value "${{ github.event.inputs.mqtt_password }}" \
            --type "SecureString" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: MQTT password"
          
          echo "MQTT parameters created"

      - name: Create RabbitMQ Parameters
        run: |
          OVERWRITE_FLAG="--overwrite"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/rabbitmq/user" \
            --value "${{ github.event.inputs.rabbitmq_user }}" \
            --type "String" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: RabbitMQ default user"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/rabbitmq/password" \
            --value "${{ github.event.inputs.rabbitmq_password }}" \
            --type "SecureString" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: RabbitMQ default password"
          
          echo "RabbitMQ parameters created"

      - name: Create Django Parameters
        run: |
          OVERWRITE_FLAG="--overwrite"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/django/secret_key" \
            --value "${{ github.event.inputs.django_secret_key }}" \
            --type "SecureString" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: Django SECRET_KEY"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/django/debug" \
            --value "0" \
            --type "String" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: Django DEBUG flag"

      - name: Create Django Superuser Parameters
        run: |
          OVERWRITE_FLAG="--overwrite"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/django/superuser/email" \
            --value "guilhermerrdias@gmail.com" \
            --type "String" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: Django superuser email"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/django/superuser/username" \
            --value "${{ github.event.inputs.django_superuser_username }}" \
            --type "String" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: Django superuser username"
          
          aws ssm put-parameter \
            --name "${{ env.PARAM_PREFIX }}/django/superuser/password" \
            --value "${{ github.event.inputs.django_superuser_password }}" \
            --type "SecureString" \
            --region "${{ env.AWS_REGION }}" \
            $OVERWRITE_FLAG \
            --description "AgroStation Production: Django superuser password"
          
          echo "Django superuser parameters created"

      - name: Verify Parameters
        run: |
          aws ssm describe-parameters \
            --filters "Key=Name,Values=${{ env.PARAM_PREFIX }}" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Parameters[*].[Name,Type]' \
            --output table
